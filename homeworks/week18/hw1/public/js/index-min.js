"use strict";function getCookie(t){for(var a=decodeURI(document.cookie).split(";"),e=0;e<a.length;e+=1){var n=a[e];if(-1!==n.indexOf(t))return n.substring(t.length+2)}}function escapeHtml(t){var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,function(t){return a[t]})}function nl2br(t,a,e){var n=e?"<br />":"<br>",r=a?"$1".concat(n):"$1".concat(n,"$2");return"".concat(t).replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,r)}var unlogin=document.querySelector("form > .unlogin");unlogin.addEventListener("click",function(){window.location="./login.php"});var leaveMsg=document.querySelector(".comments__btn-leaveMsg");leaveMsg.addEventListener("click",function(t){if(t.preventDefault(),""===document.querySelector("textarea").value)alert("你並沒有留言喔！");else{var a=$("textarea").val(),n=getCookie("csrfToken");$.ajax({type:"POST",url:"./handle/handle_add_msg.php",data:{comments:a,csrfToken:n}}).done(function(t){var a=JSON.parse(t);if(1!==a.status)return alert(a.msg);var e='\n      <section class="msgcard invisible">\n        <div class="msgcard__header">\n          <img src="'.concat(a.avatar,'" alt="avatar" class="avatar">\n          <p class="msgcard__nickname  ').concat(a.authority,'">').concat(a.nickname,'</p>\n          <p class="msgcard__datetime">').concat(a.createdTime,'</p>\n        </div>\n        <p class="msgcard__content">').concat(a.content,'</p>\n        <button class="msgcard__btn-edit" data-post_id="').concat(a.postId,'">Edit 編輯</button>')+'<button class="msgcard__btn-delete" data-post_id="'.concat(a.postId,'" data-csrftoken="').concat(n,'">Delete 刪除</button>')+'<button class="msgcard__btn-thumb" data-post_id="'.concat(a.postId,'">按讚 <i class="far fa-thumbs-up fa-lg" aria-hidden="true"></i> 0</button>\n        <form class="reply">\n          <div class="reply__wrap">\n            <textarea name="comments" class="reply__textarea" placeholder="回復留言"></textarea>\n            <button class="msgcard__btn-reply" data-parent_id="').concat(a.postId,'" data-csrfToken="').concat(n,'">Reply 回覆</button>\n          </div>\n        </form>\n      </section>');return alert(a.msg),$(".msgcard:first").before(e),$(".msgcard:first").slideDown().removeClass("invisible"),$("textarea").val(""),t}).fail(function(t){alert(t.status)})}});var contain={},msgboard=document.querySelector(".msgboard");msgboard.addEventListener("click",function(t){if(t.target.classList.contains("msgcard__btn-edit")){t.stopImmediatePropagation();var a=t.target.getAttribute("data-post_id");"P"===t.target.parentNode.children[1].nodeName&&(contain[a]=t.target.parentNode.querySelector(".msgcard__content").innerText);var e='\n  <textarea name="comments" class="msgcard__textarea">'.concat(contain[a],'</textarea>\n  <button class="msgcard__btn-send" data-post_id="').concat(a,'" data-csrftoken="').concat(getCookie("csrfToken"),'">Change 更改留言');t.target.classList.contains("editing")?(t.target.innerText="Edit 編輯",t.target.parentNode.querySelector("textarea").outerHTML='<p class="msgcard__content">'.concat(nl2br(escapeHtml(contain[a])),"</p>"),t.target.parentNode.removeChild(t.target.parentNode.querySelector(".msgcard__btn-send"))):(t.target.innerText="Cancel 取消編輯",t.target.parentNode.querySelector(".msgcard__content").outerHTML=e),t.target.classList.toggle("editing")}}),$(".msgboard").on("click",".msgcard__btn-send",function(n){n.stopImmediatePropagation();var t=$(n.target).data("post_id"),r=$(n.target).prev().val(),a=getCookie("csrfToken");$.ajax({type:"POST",url:"./handle/handle_edit_msg.php",data:{post_id:t,comments:r,csrfToken:a}}).done(function(t){var a=JSON.parse(t);if(1===a.status){alert(a.msg),$(n.target).next().text("Edit 編輯");var e='<p class="msgcard__content">'.concat(nl2br(escapeHtml(r)),"</p>");$(n.target).prev().replaceWith(e),$(n.target).next().toggleClass("editing"),$(n.target).remove()}else alert(a.msg)}).fail(function(t){alert(t.status)})}),msgboard.addEventListener("click",function(t){t.target.parentNode.classList.contains("msgcard__inside")&&!t.target.classList.contains("msgcard__textarea")&&(t.stopPropagation(),$(t.target).parent().find("form").slideToggle().removeClass("invisible"))}),$(".msgboard").on("click",".msgcard__btn-reply",function(r){if(r.preventDefault(),""===$(r.target).prev().val())return alert("你並沒有留言喔！");var t=$(r.target).prev().val(),s=getCookie("csrfToken"),c=$(r.target).data("parent_id");return $.ajax({type:"POST",url:"./handle/handle_add_msg.php",data:{comments:t,csrfToken:s,parent_id:c}}).done(function(t){var a=JSON.parse(t);if(1!==a.status)return alert(a.msg);var e=a.userId===a.parentUserId?"author":a.authority,n='\n    <div class="msgcard__inside invisible">\n      <div class="inside__header">\n      <img src="'.concat(a.avatar,'" alt="avatar" class="avatar">\n      <p class="inside__nickname  ').concat(e,'">\n        ').concat(a.nickname,'\n      </p>\n      <p class="msgcard__datetime">').concat(a.createdTime,'</p>\n    </div>\n    <p class="msgcard__content">').concat(nl2br(escapeHtml(a.content)),"</p>\n    <button class='msgcard__btn-edit' data-post_id='").concat(a.postId,"'>Edit 編輯</button>")+"<button class='msgcard__btn-delete' data-post_id='".concat(a.postId,"' data-csrfToken='").concat(s,"'>Delete 刪除</button>")+'<button class="msgcard__btn-thumb" data-post_id="'.concat(a.postId,'">按讚 <i class="far fa-thumbs-up fa-lg" aria-hidden="true"></i> 0</button>\n    <form class="reply">\n      <div class="reply__wrap">\n        <textarea name="comments" class="reply__textarea" placeholder="回復留言"></textarea>\n        <button class="msgcard__btn-reply" data-parent_id="').concat(c,'" data-csrfToken="').concat(s,'">Reply 回覆</button>\n      </div>\n    </form>');return alert(a.msg),$(r.target).parents(".msgcard").append(n),$(r.target).parents(".msgcard").children(".invisible").slideDown().removeClass("invisible"),$("textarea").val(""),t}).fail(function(t){alert(t.status)}),!1}),$(".msgboard").on("click",".msgcard__btn-delete",function(e){e.stopImmediatePropagation();var t=$(e.target).data("post_id"),a=getCookie("csrfToken");$.ajax({type:"POST",url:"./handle/handle_delete.php",data:{post_id:t,csrfToken:a}}).done(function(t){var a=JSON.parse(t);return 1!==a.status?alert(a.msg):(alert(a.msg),$(e.target).parent(".msgcard").fadeOut(500),$(e.target).parent(".msgcard__inside").fadeOut(500),t)}).fail(function(t){alert(t.status)})}),$(".msgboard").on("click",".msgcard__btn-thumb",function(t){t.stopImmediatePropagation();var n=$(t.target);$(t.target).hasClass("msgcard__btn-thumb")||(n=$(t.target).parent(".msgcard__btn-thumb"));var a=n.data("post_id");$.ajax({type:"POST",url:"./handle/handle_thumbs.php",data:{post_id:a}}).done(function(t){var a=JSON.parse(t);if(1!==a.status)return alert(a.msg);n.toggleClass("thumb-actived");var e='按讚 <i class="far fa-thumbs-up fa-lg" aria-hidden="true"></i> 0';return n.html(n.html()===e?'取消按讚 <i class="far fa-thumbs-up fa-lg" aria-hidden="true"></i> 1':e),t}).fail(function(t){alert(t.status)})});